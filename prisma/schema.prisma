generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int             @id @default(autoincrement())
  username       String          @unique
  displayName    String
  timestamp      DateTime        @default(now())
  passwordHash   String
  email          String          @unique
  defaultTheme   String          @default("dark")
  avatar         Int?
  bio            String          @default("")
  banned         Boolean         @default(false)
  role           String          @default("child")
  albums         Album[]
  comments       Comment[]
  files          File[]
  modLogs        ModLog[]
  passwordResets PasswordReset[]
  reports        Report[]
  timelines      Timeline[]
  votes          Vote[]

  @@map("users")
}

model File {
  id                 Int      @id @default(autoincrement())
  name               String?
  manifesto          String   @default("")
  timestamp          DateTime @default(now())
  removed            Boolean  @default(false)
  userId             Int?
  anonId             String
  anonTextColor      String
  anonTextBackground String
  views              Int      @default(0)
  fileName           String
  fileSize           Int
  mimeType           String
  hashedFileName     String
  fileUrl            String
  thumbnailUrl       String?
  albumId            Int?
  album              Album?   @relation(fields: [albumId], references: [id])
  user               User?    @relation(fields: [userId], references: [id])
  modLogs            ModLog[] @relation("FileModLogs")
  reports            Report[] @relation("FileReports")
  votes              Vote[]   @relation("FileVotes")

  @@map("files")
}

model Album {
  id                 Int      @id @default(autoincrement())
  name               String?
  timestamp          DateTime @default(now())
  userId             Int?
  anonId             String
  anonTextColor      String
  anonTextBackground String
  views              Int      @default(0)
  removed            Boolean  @default(false)
  manifesto          String   @default("")
  user               User?    @relation(fields: [userId], references: [id])
  files              File[]
  modLogs            ModLog[] @relation("FileModLogs")
  reports            Report[] @relation("FileReports")
  votes              Vote[]   @relation("FileVotes")

  @@map("albums")
}

model Timeline {
  id                 Int            @id @default(autoincrement())
  name               String?
  timestamp          DateTime       @default(now())
  userId             Int?
  anonId             String
  anonTextColor      String
  anonTextBackground String
  views              Int            @default(0)
  removed            Boolean        @default(false)
  manifesto          String         @default("")
  modLogs            ModLog[]       @relation("FileModLogs")
  reports            Report[]       @relation("FileReports")
  items              TimelineItem[]
  user               User?          @relation(fields: [userId], references: [id])
  votes              Vote[]         @relation("FileVotes")

  @@map("timelines")
}

model TimelineItem {
  id            Int      @id @default(autoincrement())
  timelineId    Int
  timestamp     DateTime @default(now())
  positionStart Int?
  positionEnd   Int?
  timeline      Timeline @relation(fields: [timelineId], references: [id], onDelete: Cascade)

  @@map("timeline_items")
}

model Comment {
  id                 Int       @id @default(autoincrement())
  timestamp          DateTime  @default(now())
  flavor             String
  repliesTo          Int?
  contentId          Int
  userId             Int?
  anonId             String
  anonTextColor      String
  anonTextBackground String
  text               String
  removed            Boolean   @default(false)
  replyToComment     Comment?  @relation("CommentReplies", fields: [repliesTo], references: [id])
  replies            Comment[] @relation("CommentReplies")
  user               User?     @relation(fields: [userId], references: [id])
  modLogs            ModLog[]  @relation("FileModLogs")
  reports            Report[]  @relation("FileReports")
  votes              Vote[]    @relation("FileVotes")

  @@map("comments")
}

model Vote {
  id        Int      @id @default(autoincrement())
  flavor    String
  vote      Int
  userId    Int
  contentId Int
  timestamp DateTime @default(now())
  file      Album    @relation("FileVotes", fields: [contentId], references: [id], map: "file_votes_fk")
  file      Comment  @relation("FileVotes", fields: [contentId], references: [id], map: "file_votes_fk")
  file      File     @relation("FileVotes", fields: [contentId], references: [id], map: "file_votes_fk")
  file      Timeline @relation("FileVotes", fields: [contentId], references: [id], map: "file_votes_fk")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, flavor, contentId])
  @@map("votes")
}

model Report {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  flavor    String
  contentId Int
  userId    Int?
  anonId    String
  dismissed Boolean  @default(false)
  reason    String   @default("")
  file      Album    @relation("FileReports", fields: [contentId], references: [id], map: "file_reports_fk")
  file      Comment  @relation("FileReports", fields: [contentId], references: [id], map: "file_reports_fk")
  file      File     @relation("FileReports", fields: [contentId], references: [id], map: "file_reports_fk")
  user      User?    @relation(fields: [userId], references: [id])
  file      Timeline @relation("FileReports", fields: [contentId], references: [id], map: "file_reports_fk")

  @@map("reports")
}

model ModLog {
  id            Int      @id @default(autoincrement())
  timestamp     DateTime @default(now())
  userId        Int
  flavor        String
  contentFlavor String
  contentId     Int
  details       String   @default("")
  file          Album    @relation("FileModLogs", fields: [contentId], references: [id], map: "file_modlogs_fk")
  file          Comment  @relation("FileModLogs", fields: [contentId], references: [id], map: "file_modlogs_fk")
  file          File     @relation("FileModLogs", fields: [contentId], references: [id], map: "file_modlogs_fk")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  file          Timeline @relation("FileModLogs", fields: [contentId], references: [id], map: "file_modlogs_fk")

  @@map("mod_logs")
}

model Gnaa {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  message   String
  user      String

  @@map("gnaa")
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  uuid      String   @unique
  valid     Boolean  @default(true)
  userId    Int
  email     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model Session {
  sid    String   @id
  sess   Json
  expire DateTime

  @@index([expire])
  @@map("session")
}
